# Часть 1: Поиск и исправление ошибок
Файл hub.go содержит ряд ошибок. Вот что мы наблюдаем при его использовании:

1. Сервер падает (panic) при одновременном подключении нескольких пользователей. Особенно часто, если кто-то из них отключается в момент отправки сообщений.

Одновременное чтение и запись в map, теперь все удаления пользователей через h.unregister


2. Отправленные сообщения не сохраняются в базе данных, хотя попытка сохранения вроде бы есть.

Т.к. бд нет, а в ТЗ не было её прикручивать, был добавлен обработчик ошибок, чтобы отследить, почему не сохраняется сообщение


3. После отключения пользователя сервер иногда пытается отправить ему сообщения, что вызывает ошибки.

Добавлена проверка живых каналов пользователей.


4. Есть подозрение на утечки ресурсов (незакрытые соединения).

defer c.conn.Close() в readPump


# Часть 2: Добавление нового функционала
После того как сервис станет стабильным, нужно добавить две новые функции:
1. Статус "User is typing..."
Когда пользователь начинает печатать сообщение в чате, другие участники этой же комнаты должны получить WebSocket-сообщение о том, что он печатает.
Формат сообщения: {"type": "typing_status", "payload": {"user": "имя_пользователя", "status": true}}
Если пользователь не печатает в течение 3 секунд, другим участникам должно отправиться сообщение о прекращении набора: {"type": "typing_status", "payload": {"user": "имя_пользователя", "status": false}}.
Важно: сообщения о наборе текста не нужно сохранять в базу данных

Переработана структура сообщений. Теперь все сообщения пакуются в конверт(Envelope), который имеет тип(chat_message typing_status). Добавлены обработчики типов сообщений для корректной работы. Для полностью корректной работы фронтенд должен сам считывать состояния, а так же вести таймер


2. Загрузка истории сообщений
Когда новый пользователь подключается к комнате, ему должны быть отправлены последние 10 сообщений из истории этой комнаты.
Сообщения должны прийти до того, как он сможет получать новые сообщения в реальном времени.

При апгрейде HTTP-запроса до WebSocket вызывается функция GetLastMessages(), которая отдаёт сообщения, они пакуются в конверт и отправляются по одному. Затем пользователь регистрируется, что позволяет сначала получить старые сообщения и только потом новые.

